---
title: "UKRR and OpenSAFELY comparison"
author: "Shalini Santhakumaran"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#Load libraries
library(tidyverse)
library(knitr)
library(kableExtra)

# Create directory if it doesnt exist
fs::dir_create(here::here("output", "notebooks"))

#set up empty list of datasets and demog variables
dflist<-list()
years<-c("2019", "2020", "2021")
demogs<-c("sex", "age_band", "region", "imd", "diabetes", "at_risk", "hypertension")
for (i in 1:3){
  #read in dataset
  
#pick up 1st Jan cohort as latest renal status is on or before index date
 df<-read.csv(here::here("output", "joined", paste0("input_", years[i]+1,"-01-01.csv.gz"))) 
  
  # FOR RUNNING LOCALLY
  #df<-read.csv(paste0("Z:/My Documents/OS code testing/output/joined/ckd/input_", years[i],"-12-01.csv.gz"))
  
  #set prevalent data flag and modality
  df$ukrr_prev<-as.vector(t(df[paste0("ukrr_", years[i])]))
  df$ukrr_mod<-as.vector(t(df[paste0("ukrr_", years[i],"_mod")]))
  #add variable for dialysis/tx for UKRR
  df<- df %>%
    mutate(ukrr_dtx = ifelse(ukrr_mod %in% c("ICHD", "HD", "HHD", "PD") , "Dialysis", ifelse(ukrr_mod == "Tx", "Transplant", "Not on RRT")))
  # add variable for dialysis/tx for primary care
  df<- df %>%
    mutate(latest_dtx = ifelse(latest_renal_status %in% c("Dialysis", "Transplant", "RRT_unknown") , latest_renal_status, "Not on RRT"))
  # order factor
  df$ukrr_dtx<-factor(df$ukrr_dtx, levels=c("Not on RRT", "Dialysis", "Transplant"))
  df$latest_dtx<-factor(df$latest_dtx, levels=c("Not on RRT", "Dialysis", "Transplant", "RRT_unknown"))
  # add variable for source
  df<-df %>%
    mutate(rrt_source = ifelse(ukrr_prev==1 & latest_renal_status %in%  c("Dialysis", "Transplant", "RRT_unknown"), "Both",
                               ifelse (ukrr_prev==1 & !(latest_renal_status %in%  c("Dialysis", "Transplant", "RRT_unknown")), "UKRR only",
                                    ifelse(ukrr_prev!=1 & latest_renal_status %in%  c("Dialysis", "Transplant", "RRT_unknown"), "PC only",
                                           "Neither"))))
  #put dataset into list
  dflist[[i]] <- df
}

```

## Introduction
This report compares data on people prevalent to renal replacement therapy (RRT) as captured by the UK Renal Registry (UKRR) and primary care data in OpenSAFELY.  

#### Population
People over 18 years of age, alive and registered to a TPP practice at the end of the prevalent year.

#### Definition if RRT status
For the UKRR data, patients are classified as part of the prevalent cohort if they are alive and on RRT at the end of the year, as reported by all renal centres in England. The 2021 cohort is based on provisional data from the renal centres and has not been validated. In particular, some patients on acute dialysis may be included. <br>
For the primary care data, patients are classified based on the last recorded code in the dialysis, transplant and RRT codelists.  If both dialysis and transplant codes were recorded on the same day, then the renal status is classed as 'RRT unknown'. If RRT and CKD codes are recorded on the same day, then the renal status is based on the RRT code.

#### Links
[OpenSAFELY dialysis primary care codelist](https://www.opencodelists.org/codelist/opensafely/dialysis/2020-07-16/) <br>
[OpenSAFELY transplant primary care codelist](https://www.opencodelists.org/codelist/opensafely/kidney-transplant/2020-07-15/)<br>
[OpenSAFELY renal replacement therapy codelist](https://www.opencodelists.org/codelist/opensafely/renal-replacement-therapy/2020-04-14/)<br>
[GitHub repository for this analysis](https://github.com/opensafely/renal-short-data-report)<br>

## Results

#### 1 People prevalent to RRT by data source
Percentages exclude people not on RRT in either source.
```{r, echo=FALSE, results='asis'}
#table for numbers
ntable<-function(x){
  table(x$ukrr_prev, x$latest_renal_status %in% c("Dialysis", "Transplant", "RRT_unknown"))
}
#filter dataset to exclude patients with no RRT in either OS or UKRR as this is what we want to show pct by
keepRRT<-function(x){
  filter(x , ukrr_prev==1 | latest_renal_status %in% c("Dialysis", "Transplant", "RRT_unknown"))
}
#combine N and % in one table
mytable <- function(x){
  m1<-cbind(ntable(x), round(100*prop.table(ntable(keepRRT(x))),1))
  m2 <- m1[, c(matrix(1:ncol(m1), nrow = 2, byrow = T))]  
  colnames(m2) <-rep("",4)
  rownames(m2) <- c("not RRT", "RRT")
  m2[1,1]<-paste0("\\(", m2[1,1], ")") #placing first cell in brackets as not really interested in these
  return(m2)
}
#applying to all in list
list.of.dts<-lapply(dflist, mytable)
for(i in 1:length(list.of.dts)) {
  k<- list.of.dts[[i]] %>%
          kbl(caption=paste0("Table 1.",i, " RRT status by data source, ",  years[i]), booktabs=TRUE) %>%
          add_header_above(c("UKRR", "n", "%", "n", "%")) %>%
          add_header_above(c("","Not on RRT"=2, "RRT"=2)) %>%
          add_header_above(c("", "Primary care" = 4)) %>%
          kable_styling()
  print(k)
}

```

#### 2 - Modality by data source
Some of the patients not on RRT will be CKD patients in the UKRR data source, but that group will be considered separately later.
```{r, echo=FALSE, results='asis'}
#table for numbers
list.of.dts<-lapply(dflist, function (x) x %>%
  count(ukrr_mod, latest_renal_status) %>%
  spread(latest_renal_status, n, fill=0) %>%
  mutate(ukrr_mod= replace(ukrr_mod, ukrr_mod=="", "Not on RRT")) %>%
  rename(UKRR=ukrr_mod) %>%
  mutate_all(~ifelse(.<5,"<5",.)))

for(i in 1:length(list.of.dts)) {
  k<- list.of.dts[[i]] %>%
          kbl(caption=paste0("Table 2.",i, " Modality by data source, ",  years[i]), booktabs=TRUE) %>%
          add_header_above(c("", "Primary care" = ncol(list.of.dts[[i]]) - 1)) %>%
          kable_styling()
  print(k)
}
```

#### 3 - Agreement between dialysis and transplant
Excludes people not on RRT in either source.
```{r, echo=FALSE, results='asis'}
#table for numbers
ntable<-function(x){
  table(keepRRT(x)$ukrr_dtx, keepRRT(x)$latest_dtx)
}

#combine N and % in one table
mytable <- function(x){
  m1<-cbind(ntable(x), round(100*prop.table(ntable(x)),1))
  m2 <- m1[, c(matrix(1:ncol(m1), nrow = 2, byrow = T))]  
  #colnames(m2) <-paste0(colnames(m2), rep(c(" n", " %"), 4))
  return(m2)
}
#applying to all in list
list.of.dts<-lapply(dflist, mytable)
for(i in 1:length(list.of.dts)) {
    names<-unique(colnames(list.of.dts[[i]])) #save existing colnames
    colnames(list.of.dts[[i]])<-rep("",length(names)*2) # blank colnames
   k<- list.of.dts[[i]] %>%
          kbl(caption=paste0("Table 3.",i, " Agreement of dialysis and transplant between data sources, ",  years[i]), booktabs=TRUE) %>% 
          add_header_above(c("UKRR", rep(c("n", "%"), length(names)))) %>% 
         add_header_above(data.frame(c("", names), c(1,rep(2, length(names))))) %>%  #setting colnames as a dataframe 
          add_header_above(c("", "Primary care" =  length(names)*2 )) %>%
          kable_styling()
  print(k)
}

```

### 4 - Agreement by demographics
Capture of RRT patients in each data source, by demographics.

```{r, echo=FALSE, results='asis'}
dtable<-function(x, y) {
    y1<-keepRRT(y)
    m1<-cbind(table(y1[,x],y1$rrt_source),
              round(100*prop.table(table(y1[,x],y1$rrt_source), margin=1),1))
    m2 <- m1[, c(matrix(1:ncol(m1), nrow = 2, byrow = T))]  
    #colnames(m2) <-paste0(colnames(m2), rep(c(" n", " %"), 3))
    return(m2)
}

list.of.dts<-lapply(dflist, function(y) lapply(demogs, function(x) dtable(x, y)))

for(i in 1:length(list.of.dts)) {
  for(j in 1:length(list.of.dts[[i]])){
   names<-unique(colnames(list.of.dts[[i]][[j]])) #save existing colnames
    colnames(list.of.dts[[i]][[j]])<-rep("",length(names)*2) # blank colnames
   k<- list.of.dts[[i]][[j]]%>%
          kbl(caption=paste0("Table 4.", i, "." , j, " Data source for RRT patients, by ", demogs[j], ", ", years[i] ), booktabs=TRUE) %>% 
          add_header_above(c(demogs[j], rep(c("n", "%"), length(names)))) %>%
          add_header_above(data.frame(c("", names), c(1,rep(2, length(names))))) %>%  #setting colnames as a dataframe 
          kable_styling()
  print(k)     
  }
}

```
